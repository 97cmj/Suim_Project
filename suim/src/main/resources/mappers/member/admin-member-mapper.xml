<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="adminMemberMapper">

	<!-- MEMBER 테이블로부터 조회된 ResultSet 에 들은 데이터를 Member VO 로 가공해주는 용도 -->
	<resultMap id="adminMemberResultSet" type="member">
		<result column="MEMBER_ID" property="memberId" />
		<result column="MEMBER_PWD" property="memberPwd" />
		<result column="MEMBER_NAME" property="memberName" />
		<result column="NICKNAME" property="nickName" />
		<result column="PHONE" property="phone" />
		<result column="EMAIL" property="email" />
		<result column="GENDER" property="gender" />
		<result column="AREA" property="area" />
		<result column="BIRTH" property="birth" />
		<result column="ENROLL_DATE" property="enrollDate" />
		<result column="MODIFY_DATE" property="modifyDate" />
		<result column="LOGIN_DATE" property="loginDate" />
		<result column="CHANGE_NAME" property="changeName" />
		<result column="STATUS" property="status" />
	</resultMap>

	<!-- 총 갯수 구하는 쿼리문 -->
	<select id="selectListCount" resultType="_int">
		SELECT COUNT(*)
		  FROM MEMBER
	</select>
	
	<!-- 리스트를 구해주는 쿼리문 -->
	<select id="selectList" resultMap="adminMemberResultSet">
	<!-- 
		SELECT MEMBER_ID
			 , MEMBER_NAME
			 , NICKNAME
			 , PHONE
			 , EMAIL
			 , GENDER
			 , AREA
			 , BIRTH
			 , ENROLL_DATE
			 , LOGIN_DATE
			 , STATUS
		  FROM MEMBER
		 ORDER BY ENROLL_DATE DESC
	-->
		SELECT M.MEMBER_ID
		     , M.MEMBER_NAME
		     , M.NICKNAME
		     , M.PHONE
		     , M.EMAIL
		     , M.GENDER
		     , M.AREA
		     , M.BIRTH
		     , M.ENROLL_DATE
		     , M.LOGIN_DATE
		     , M.STATUS
		     , CASE WHEN B.MEMBER_ID IS NULL THEN 0 ELSE 1 END AS BLACKLIST_FLAG
		FROM MEMBER M
		LEFT JOIN (
		    SELECT R.MEMBER_ID
		    FROM REPORT R
		    JOIN MEMBER USING(MEMBER_ID)
		    GROUP BY R.MEMBER_ID
		    HAVING COUNT(*) >= 5
		) B ON M.MEMBER_ID = B.MEMBER_ID
		ORDER BY M.ENROLL_DATE DESC;
	</select>
	
	<!-- 블랙리스트 처리용 쿼리문 -->
	<select id="selectBlackList">
         SELECT MEMBER_ID
           FROM REPORT R
           JOIN MEMBER USING(MEMBER_ID)
          WHERE MEMBER_ID = #{memberId}
          GROUP BY MEMBER_ID
         HAVING COUNT(*) >= 5
	</select>
	
	<!-- 회원 상세 조회용 쿼리문 -->
	<select id="selectMember" parameterType="string" resultMap="adminMemberResultSet">
		SELECT MEMBER_ID
			 , MEMBER_NAME
			 , NICKNAME
			 , PHONE
			 , EMAIL
			 , GENDER
			 , AREA
			 , BIRTH
			 , ENROLL_DATE
			 , MODIFY_DATE
			 , LOGIN_DATE
			 , CHANGE_NAME
			 , STATUS
		  FROM MEMBER
		 WHERE MEMBER_ID = #{memberId}
	</select>

	<!-- 회원 삭제용 쿼리문 -->
	<update id="deleteMember" parameterType="string">
		UPDATE MEMBER
		   SET STATUS = '탈퇴'
		 WHERE MEMBER_ID = #{memberId}
	</update>
	
	<!-- 조회수 top5 게시글 조회용 쿼리문 -->
	<select id="selectTopMemberList" resultMap="adminMemberResultSet">
		SELECT ROWNUM, B.*
		FROM (SELECT MEMBER_ID
		           , MEMBER_TITLE
		           , MEMBER_WRITER
		           , COUNT
		           , TO_CHAR(CREATE_DATE, 'YYYY-MM-DD') AS "CREATE_DATE"
		           , ORIGIN_NAME
		        FROM MEMBER
		       WHERE STATUS = 'Y'
		       ORDER BY COUNT DESC) B
		WHERE ROWNUM BETWEEN 1 AND 5
	</select>

</mapper>